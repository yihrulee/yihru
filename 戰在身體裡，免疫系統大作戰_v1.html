<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ°åœ¨èº«é«”è£¡ï¼Œå…ç–«ç³»çµ±å¤§ä½œæˆ°</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#64748b;--text:#e5e7eb;
      --accent:#22c55e;--accent2:#38bdf8;--danger:#ef4444;--surface:#0b1220;
      --amber:#f59e0b;--violet:#a78bfa;}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--surface),var(--bg));
      color:var(--text);font-family:"Noto Sans TC","Segoe UI",system-ui,Arial,sans-serif;}
    header{padding:20px 24px;border-bottom:1px solid #1f2937;position:sticky;top:0;
      background:rgba(11,18,32,.9);backdrop-filter:blur(8px);}
    h1{margin:0;font-size:22px}
    .container{max-width:1360px;margin:20px auto;padding:0 16px;
      display:grid;grid-template-columns:400px 1fr 560px;gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .left,.right,.insights{padding:18px}
    .right{display:grid;grid-template-rows:auto auto 1fr;gap:12px}
    .field{margin-bottom:14px}
    label{display:block;margin-bottom:8px;color:#cbd5e1;font-size:13px}
    .pill{background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;
      padding:10px 12px;border-radius:12px;display:flex;align-items:center;gap:8px;width:100%}
    .radio-list{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .radio{background:#0b1220;border:1px solid #1f2937;padding:10px;border-radius:12px;
      cursor:pointer;display:flex;gap:8px;align-items:center}
    .radio input{accent-color:var(--accent)}
    .chips{display:grid;gap:8px}
    .chips.four{grid-template-columns:repeat(4,1fr)}
    .chips.six{grid-template-columns:repeat(2,1fr)}
    .chips.two{grid-template-columns:repeat(2,1fr)}
    @media (min-width: 480px){ .chips.six{grid-template-columns:repeat(3,1fr)} }
    .chip{position:relative}
    .chip input{position:absolute;opacity:0;pointer-events:none}
    .chip span{display:block;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb;
      padding:10px 12px;border-radius:12px;text-align:center;cursor:pointer;font-size:13px;line-height:1.2}
    .chip input:checked + span{outline:2px solid #22c55e;background:rgba(34,197,94,.08)}
    .chip span small{display:block;color:#93c5fd;font-size:11px;margin-top:4px}
    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:600}
    .primary{background:linear-gradient(90deg,var(--accent2),var(--accent));color:#0b1220}
    .ghost{background:#0b1220;color:#cbd5e1;border:1px solid #1f2937}
    .util{background:#0b1220;color:#a7f3d0;border:1px solid #065f46}
    .arena{position:relative;background:#0b1220;border:1px dashed #233047;
      border-radius:16px;padding:16px;min-height:260px}
    .side{display:flex;align-items:center;gap:12px}
    .side .avatar{width:48px;height:48px;border-radius:999px;display:grid;place-items:center;font-size:26px}
    .pathogen{--c:var(--danger)} .immune{--c:var(--accent2)}
    .side.pathogen .avatar{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4)}
    .side.immune .avatar{background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.4)}
    .hp{flex:1}
    .bar{height:12px;background:#111827;border-radius:999px;overflow:hidden;border:1px solid #1f2937}
    .bar>i{display:block;height:100%;width:100%;background:linear-gradient(90deg,var(--c),#22d3ee)}
    .labels{display:flex;justify-content:space-between;font-size:12px;color:#cbd5e1;margin-top:4px}
    .log{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px;overflow:auto;max-height:300px;font-size:13px}
    .log p{margin:0 0 8px}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;border-radius:999px;padding:6px 10px;border:1px solid #233047;background:#0b1220}
    .good{color:#86efac;border-color:#14532d} .poor{color:#fca5a5;border-color:#7f1d1d}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .panel{border:1px solid #1f2937;background:#0b1220;border-radius:12px;padding:8px}
    .lv{font-weight:700}
    .xpbar{height:8px;background:#111827;border:1px solid #1f2937;border-radius:999px;overflow:hidden;margin-top:6px}
    .xpbar>i{display:block;height:100%;background:linear-gradient(90deg,var(--violet),var(--amber))}
    /* insights */
    .mini{font-size:12px;color:#93c5fd}
    .chart-wrap{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
    canvas{background:#0b1220;border:1px solid #1f2937;border-radius:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
    th,td{border:1px solid #1f2937;padding:6px 8px} th{color:#cbd5e1}
    .controls{display:grid;grid-template-columns:1fr;gap:8px;margin:8px 0}
    .legend{display:flex;gap:12px;align-items:center;margin:6px 0 10px 4px;font-size:12px;color:#cbd5e1}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    @media (max-width: 1180px){ .container{grid-template-columns:1fr} .right{grid-template-rows:auto auto auto} }
  </style>
</head>
<body>
<header><h1>æˆ°åœ¨èº«é«”è£¡ï¼Œå…ç–«ç³»çµ±å¤§ä½œæˆ°</h1></header>

<main class="container">
  <!-- å·¦å´è¨­å®š -->
  <section class="card left">
    <h2>è¨­å®šæˆ°é¬¥æ¢ä»¶</h2>

    <div class="field">
      <label>â‘  ç—…åŸé«”ç¨®é¡</label>
      <div class="chips four" role="radiogroup" aria-label="ç—…åŸé«”ç¨®é¡">
        <label class="chip"><input type="radio" name="pathType" value="virus" checked /><span>ç—…æ¯’<small>ğŸ§¬ RNA/DNA</small></span></label>
        <label class="chip"><input type="radio" name="pathType" value="bacteria" /><span>ç´°èŒ<small>ğŸ§« å–®ç´°èƒ</small></span></label>
        <label class="chip"><input type="radio" name="pathType" value="fungus" /><span>çœŸèŒ<small>ğŸ„ èŒçµ²</small></span></label>
        <label class="chip"><input type="radio" name="pathType" value="protozoa" /><span>åŸèŸ²<small>ğŸ¦  é­æ¯›/çº–æ¯›</small></span></label>
      </div>
    </div>

    <div class="field">
      <label>â‘¡ äººé«”ç‹€æ³</label>
      <div class="chips six" role="radiogroup" aria-label="äººé«”ç‹€æ³">
        <label class="chip"><input type="radio" name="bodyState" value="fit_exercise" checked /><span>ç¶“å¸¸é‹å‹•<small>å…ç–«å¼·</small></span></label>
        <label class="chip"><input type="radio" name="bodyState" value="fit_sleep" /><span>ç¡çœ å……è¶³<small>å…ç–«å¼·</small></span></label>
        <label class="chip"><input type="radio" name="bodyState" value="fit_nutrition" /><span>ç‡Ÿé¤Šå‡è¡¡<small>å…ç–«å¼·</small></span></label>
        <label class="chip"><input type="radio" name="bodyState" value="weak_noexercise" /><span>å¹¾ä¹ä¸é‹å‹•<small>å…ç–«å¼±</small></span></label>
        <label class="chip"><input type="radio" name="bodyState" value="weak_nightowl" /><span>ç¶“å¸¸ç†¬å¤œ<small>å…ç–«å¼±</small></span></label>
        <label class="chip"><input type="radio" name="bodyState" value="weak_poordiet" /><span>é£²é£Ÿä¸æ­£å¸¸<small>å…ç–«å¼±</small></span></label>
      </div>
    </div>

    <div class="field">
      <label>â‘¢ ç–«è‹—ç‹€æ…‹</label>
      <div class="chips two" role="radiogroup" aria-label="ç–«è‹—ç‹€æ…‹">
        <label class="chip"><input type="radio" name="vaccStatus" value="UNVACC" checked /><span>æœªæ¥ç¨®ç–«è‹—</span></label>
        <label class="chip"><input type="radio" name="vaccStatus" value="VACC" /><span>å·²æ–½æ‰“ç–«è‹—</span></label>
      </div>
    </div>

    <div class="field">
      <label>â‘£ é€²æ”»å…¥å£</label>
      <div class="radio-list" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label class="radio"><input type="radio" name="route" value="intact_skin" checked> å®Œæ•´çš®è†š</label>
        <label class="radio"><input type="radio" name="route" value="oral"> å£è…”</label>
        <label class="radio"><input type="radio" name="route" value="nasal"> é¼»è…”</label>
        <label class="radio"><input type="radio" name="route" value="wounded_skin"> å—å‚·çš„çš®è†š</label>
      </div>
    </div>

    <div class="actions">
      <button class="primary" id="btnStart">ğŸš€ é–‹å§‹å°æˆ°</button>
      <button class="ghost" id="btnReset">â†» é‡è¨­</button>
      <button class="util" id="btnClearStats" title="æ¸…é™¤çµ±è¨ˆè³‡æ–™">ğŸ§¹ æ¸…ç©ºçµ±è¨ˆ</button>
    </div>
    <p class="mini">å³å´ä¸‰å¼µåœ–æ”¯æ´<b>è¦–åœ–æŒ‰éˆ•</b>ï¼šæœªæ¥ç¨®ï¼å·²æ–½æ‰“ç–«è‹—ï¼æ¯”è¼ƒï¼ˆç¾¤çµ„æŸ±ï¼‰ï¼å…¨éƒ¨ã€‚ç¸±è»¸=å°æˆ°çµæŸæ™‚çš„<b>å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼</b>ï¼ˆæ•´æ•¸åˆ»åº¦ï¼‰ã€‚</p>

    <div class="stats">
      <div class="panel">ç—…åŸé«” Lv <span id="pLv">1</span>ï¼ˆXP <span id="pXP">0</span>/<span id="pNext">100</span>)<div class="xpbar"><i id="pXPBar" style="width:0%"></i></div></div>
      <div class="panel">å…ç–« Lv <span id="iLv">1</span>ï¼ˆXP <span id="iXP">0</span>/<span id="iNext">100</span>)<div class="xpbar"><i id="iXPBar" style="width:0%"></i></div></div>
    </div>
    <div class="panel" style="margin-top:8px">å…ç–«è¨˜æ†¶ï¼š<span id="memoBadge">ç„¡</span></div>
  </section>

  <!-- ä¸­é–“æˆ°é¬¥å ´æ™¯ -->
  <section class="card right">
    <div class="badges" id="statusBadges"></div>
    <div class="arena">
      <div class="side pathogen"><div class="avatar" id="pAvatar">ğŸ¦ </div><div class="hp"><div class="bar"><i id="pBar" style="width:100%"></i></div><div class="labels"><span>ç—…åŸé«”è² è·</span><span id="pHpLabel">100 / 100</span></div></div></div>
      <div style="height:10px"></div>
      <div class="side immune"><div class="avatar">ğŸ›¡ï¸</div><div class="hp"><div class="bar"><i id="iBar" style="width:100%"></i></div><div class="labels"><span>å…ç–«é˜²ç¦¦åŠ›</span><span id="iHpLabel">100 / 100</span></div></div></div>
    </div>
    <div class="log" id="log"></div>
  </section>

  <!-- å³å´çµ±è¨ˆï¼šä¸‰å¼µåœ–ï¼ˆç—…åŸé«” / äººé«”ç‹€æ³ / å…¥å£ï¼‰ -->
  <section class="card insights">
    <h3 style="margin:0 0 8px">ğŸ“Š çµ±è¨ˆ / åœ–è¡¨ï¼ˆå¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼‰</h3>

    <div class="controls">
      <label>ç–«è‹—è¦–åœ–</label>
      <div class="chips four" role="radiogroup" aria-label="ç–«è‹—è¦–åœ–">
        <label class="chip"><input type="radio" name="vaccView" value="UNVACC" /><span>æœªæ¥ç¨®</span></label>
        <label class="chip"><input type="radio" name="vaccView" value="VACC" /><span>å·²æ–½æ‰“ç–«è‹—</span></label>
        <label class="chip"><input type="radio" name="vaccView" value="COMPARE" /><span>æ¯”è¼ƒï¼ˆç–«è‹— vs æœªæ¥ç¨®ï¼‰</span></label>
        <label class="chip"><input type="radio" name="vaccView" value="ALL" checked /><span>å…¨éƒ¨</span></label>
      </div>
      <div class="legend" id="legend" style="display:none;">
        <span><i class="dot" style="background:#38bdf8"></i> å·²æ–½æ‰“ç–«è‹—</span>
        <span><i class="dot" style="background:#f59e0b"></i> æœªæ¥ç¨®</span>
      </div>
    </div>

    <div class="chart-wrap">
      <div>
        <div class="mini">ä¾ã€Œç—…åŸé«”ç¨®é¡ã€çš„å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼</div>
        <canvas id="chartByType" width="520" height="220"></canvas>
      </div>
      <div>
        <div class="mini">ä¾ã€Œäººé«”ç‹€æ³ã€çš„å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼</div>
        <canvas id="chartByState" width="520" height="220"></canvas>
      </div>
      <div>
        <div class="mini">ä¾ã€Œé€²æ”»å…¥å£ã€çš„å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼</div>
        <canvas id="chartByRoute" width="520" height="220"></canvas>
      </div>
    </div>

    <table>
      <thead id="thead">
        <tr><th>ç¶­åº¦</th><th>åˆ†é¡</th><th>æ¨£æœ¬æ•¸</th><th>å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼</th><th>å…ç–«æˆåŠŸç‡</th></tr>
      </thead>
      <tbody id="summaryRows"><tr><td colspan="5" style="text-align:center;color:#94a3b8">å°šç„¡è³‡æ–™ï¼Œå…ˆé€²è¡Œå¹¾å ´å°æˆ°å§ï¼</td></tr></tbody>
    </table>
  </section>
</main>

<script>
// ===== éŠæˆ²æ ¸å¿ƒï¼ˆå«çµ±è¨ˆï¼‰ =====
const $=(q)=>document.querySelector(q);const logEl=$('#log');const memoBadge=$('#memoBadge');const badgesEl=$('#statusBadges');
const prog={pLv:1,pXP:0,pNext:100,iLv:1,iXP:0,iNext:100, memoryLevel:0};
const history=[]; // ç´¯ç©æˆ°å ±

function log(msg,type=""){const p=document.createElement('p');p.innerHTML=msg;if(type==='bad')p.style.color='#fca5a5';if(type==='good')p.style.color='#86efac';if(type==='event')p.style.color='#fbbf24';logEl.appendChild(p);logEl.scrollTop=logEl.scrollHeight;}
function resetLog(){logEl.innerHTML='';}
let pathogen={load:100,max:100};let immune={power:100,max:100};
function updateBars(){const pPct=Math.max(0,pathogen.load)/pathogen.max*100;$('#pBar').style.width=pPct+'%';$('#pHpLabel').textContent=`${Math.round(pathogen.load)} / ${pathogen.max}`;const iPct=Math.max(0,immune.power)/immune.max*100;$('#iBar').style.width=iPct+'%';$('#iHpLabel').textContent=`${Math.round(immune.power)} / ${immune.max}`;}
function addXP(side,amt){if(side==='p'){prog.pXP+=amt;while(prog.pXP>=prog.pNext){prog.pXP-=prog.pNext;prog.pLv++;prog.pNext=Math.round(100*(1+0.25*(prog.pLv-1)));log(`â¬†ï¸ ç—…åŸé«”å‡ç´š Lv${prog.pLv}`,'event');}}else{prog.iXP+=amt;while(prog.iXP>=prog.iNext){prog.iXP-=prog.iNext;prog.iLv++;prog.iNext=Math.round(100*(1+0.25*(prog.iLv-1)));log(`â¬†ï¸ å…ç–«ç³»çµ±å‡ç´š Lv${prog.iLv}`,'event');}}$('#pLv').textContent=prog.pLv;$('#iLv').textContent=prog.iLv;$('#pXP').textContent=prog.pXP;$('#iXP').textContent=prog.iXP;$('#pNext').textContent=prog.pNext;$('#iNext').textContent=prog.iNext;$('#pXPBar').style.width=(prog.pXP/prog.pNext*100)+'%';$('#iXPBar').style.width=(prog.iXP/prog.iNext*100)+'%';}

// æ¨™ç±¤
const labelPT={virus:'ç—…æ¯’',bacteria:'ç´°èŒ',fungus:'çœŸèŒ',protozoa:'åŸèŸ²'};
const labelST={fit_exercise:'ç¶“å¸¸é‹å‹•',fit_sleep:'ç¡çœ å……è¶³',fit_nutrition:'ç‡Ÿé¤Šå‡è¡¡',weak_noexercise:'å¹¾ä¹ä¸é‹å‹•',weak_nightowl:'ç¶“å¸¸ç†¬å¤œ',weak_poordiet:'é£²é£Ÿä¸æ­£å¸¸'};
const labelRT={intact_skin:'å®Œæ•´çš®è†š',oral:'å£è…”',nasal:'é¼»è…”',wounded_skin:'å—å‚·çš®è†š'};
const keysPT=['virus','bacteria','fungus','protozoa'];
const keysST=['fit_exercise','fit_sleep','fit_nutrition','weak_noexercise','weak_nightowl','weak_poordiet'];
const keysRT=['intact_skin','oral','nasal','wounded_skin'];

// ä¾æ¢ä»¶å»ºç«‹å…ç–«èƒ½åŠ›ï¼ˆæ ¡æº–ï¼šå¼·>å¼±ã€ç–«è‹—>æœªï¼‰ï¼‹ç—…åŸé«”/å…¥å£äº¤äº’ä½œç”¨ï¼ˆå°å¹…ï¼‰
function immunityProfile(sel){
  let innate=1,adaptive=1;
  const strong=['fit_exercise','fit_sleep','fit_nutrition'].includes(sel.state);
  const weak=['weak_noexercise','weak_nightowl','weak_poordiet'].includes(sel.state);
  if(strong){innate=1.35;adaptive=1.35;} if(weak){innate=0.75;adaptive=0.75;}
  if(sel.vaccinated){adaptive+=0.40;}
  // ç—…åŸé«” Ã— å…¥å£ï¼šå°å¹…å½±éŸ¿å…ç–«è¼¸å‡ºï¼ˆä¸ç ´å£å¼·>å¼±ã€ç–«è‹—>æœªï¼‰
  let routeAdj=1;
  if(sel.type==='virus' && sel.route==='nasal') routeAdj=0.93;         // é£›æ²«/é¼»è…”ï¼Œç¨ä¸åˆ©å…ç–«
  if(sel.type==='virus' && sel.route==='oral') routeAdj=0.95;          // å£è…”ä¹Ÿæœ‰äº›æŒ‘æˆ°
  if(sel.type==='bacteria' && sel.route==='wounded_skin') routeAdj=0.92; // å‚·å£æ˜“ç´°èŒæ„ŸæŸ“
  if(sel.type==='fungus' && sel.route==='intact_skin') routeAdj=0.95;    // çš®è†šçœŸèŒè¼ƒé ‘å›º
  if(sel.type==='protozoa' && sel.route==='oral') routeAdj=0.97;         // ç¶“å£è·¯å¾‘å°å½±éŸ¿
  innate*=routeAdj; adaptive*=routeAdj;

  if(prog.memoryLevel>0){adaptive+=0.15*prog.memoryLevel; memoBadge.textContent='è¨˜æ†¶ Lv'+prog.memoryLevel;} else {memoBadge.textContent='ç„¡';}
  return{innate,adaptive,strong,weak};
}

function chance(p){return Math.random()<p;}

function simulateBattle(sel){
  resetLog();
  pathogen.load=100+(prog.pLv-1)*5;pathogen.max=pathogen.load;
  immune.power=100+(prog.iLv-1)*5;immune.max=immune.power;
  updateBars();
  let round=1, outcome=''; const profile=immunityProfile(sel);

  // å£è…”äº‹ä»¶ç‹€æ…‹
  let salivaBuffTurns = 0; // 2 å›åˆ buff
  let acidChecked = false; // åƒ…æª¢æŸ¥ä¸€æ¬¡

  // ç‹€æ…‹å¾½ç« 
  badgesEl.innerHTML='';
  const addBadge=(t,c='')=>{const s=document.createElement('span');s.className='badge '+c;s.textContent=t;badgesEl.appendChild(s);};
  addBadge('ç—…åŸé«”ï¼š'+labelPT[sel.type]);
  addBadge('ç‹€æ…‹ï¼š'+labelST[sel.state], profile.strong?'good':'');
  if(profile.weak) addBadge('å…ç–«å¼±åŒ–','poor');
  if(sel.vaccinated) addBadge('å·²æ–½æ‰“ç–«è‹—','good'); else addBadge('æœªæ¥ç¨®ç–«è‹—');
  addBadge('å…¥å£ï¼š'+labelRT[sel.route]);

  log('âš”ï¸ å°æˆ°é–‹å§‹ï¼');
  const timer=setInterval(()=>{
    // éš¨æ©Ÿäº‹ä»¶ï¼šé¼»è…” â†’ æ‰“å™´åš
    if(sel.route==='nasal'&&chance(0.2*profile.innate)){
      clearInterval(timer); log('ğŸ¤§ <b>æ‰“å™´åšï¼</b> ç—…åŸé«”è¢«æ’å‡ºã€‚','event'); addXP('i',40); prog.memoryLevel=Math.min(3, prog.memoryLevel+1); outcome='sneeze'; finalize(outcome, round-1); return;
    }

    // éš¨æ©Ÿäº‹ä»¶ï¼šå£è…” â†’ å”¾æ¶²/æº¶èŒé…¶åŠ æˆï¼ˆå›åˆ1â€“2ä¹‹é–“æœ‰æ©Ÿç‡è§¸ç™¼ï¼ŒæŒçºŒ2å›åˆï¼Œå…ç–«è¼¸å‡º+15%ï¼‰
    if(sel.route==='oral' && round<=2 && salivaBuffTurns===0 && chance(0.25*profile.innate)){
      salivaBuffTurns = 2;
      addBadge('å”¾æ¶²/æº¶èŒé…¶åŠ æˆ','good');
      log('ğŸ§ª <b>å”¾æ¶²ï¼æº¶èŒé…¶åŠ æˆ</b>å•Ÿå‹•ï¼šæ¥ä¸‹ä¾† 2 å›åˆå…ç–«è¼¸å‡º +15%ã€‚','event');
    }

    // éš¨æ©Ÿäº‹ä»¶ï¼šå£è…” â†’ èƒƒé…¸æ®ºæ»…ï¼ˆå›åˆâ‰¥3 æª¢æŸ¥ä¸€æ¬¡ï¼Œé«˜æ©Ÿç‡å¤§é‡å‰Šæ¸›æˆ–ç›´æ¥æ¶ˆæ»…ï¼‰
    if(sel.route==='oral' && !acidChecked && round>=3){
      acidChecked = true;
      if(chance(0.45*profile.innate)){
        clearInterval(timer);
        log('ğŸ§ª <b>èƒƒé…¸æ®ºæ»…ï¼</b> ç—…åŸé«”è¢«æ¶ˆæ»…ã€‚','event');
        addXP('i',50); // å…ˆå¤©å±éšœæˆåŠŸï¼Œä½†ä¸å¢åŠ å…ç–«è¨˜æ†¶
        outcome='gastric_acid';
        finalize(outcome, round-1);
        return;
      }
    }

    // æœ¬å›åˆæˆ°é¬¥è¨ˆç®—
    let immuneDamage=(10*profile.innate)+14*profile.adaptive*Math.min(1,(round-2)/4);
    if(salivaBuffTurns>0){ immuneDamage*=1.15; salivaBuffTurns--; }
    let pathogenDamage=10+(prog.pLv-1)*2; if(profile.strong)pathogenDamage*=0.8; if(profile.weak)pathogenDamage*=1.15;

    pathogen.load-=immuneDamage; immune.power-=pathogenDamage; updateBars();
    log(`ç¬¬${round}å›åˆï¼šå…ç–«é€ æˆ${immuneDamage.toFixed(0)}ï¼›ç—…åŸé«”åæ“Š${pathogenDamage.toFixed(0)}ã€‚`);

    if(pathogen.load<=0||immune.power<=0||round>=12){
      clearInterval(timer);
      if(pathogen.load<=0){log('âœ… ç—…åŸé«”è¢«æ®²æ»…ï¼','good'); addXP('i',60); prog.memoryLevel=Math.min(3, prog.memoryLevel+1); outcome='immune_win';}
      else if(immune.power<=0){log('âŒ å…ç–«ç³»çµ±å´©æ½°ï¼','bad'); addXP('p',60); outcome='pathogen_win';}
      else {log('âš–ï¸ é›™æ–¹åƒµæŒã€‚'); addXP('p',30); addXP('i',30); outcome='stalemate';}
      finalize(outcome, round);
      return;
    }
    round++;
  }, 700);

  function finalize(outcome, rounds){
    const immuneEnd = Math.max(0, Math.round(immune.power));
    // æ ¡æº–åˆ†æ•¸ï¼šç¢ºä¿ å¼·>å¼± èˆ‡ ç–«è‹—>æœª åœ¨åŒæ¢ä»¶ä¸‹æˆç«‹
    const strongBias = (['fit_exercise','fit_sleep','fit_nutrition'].includes(sel.state)) ? +10 : (['weak_noexercise','weak_nightowl','weak_poordiet'].includes(sel.state) ? -10 : 0);
    const vaccBias = sel.vaccinated ? +8 : 0;
    // ç—…åŸé«”é™„åŠ åç§»ï¼ˆå°æ–¼å¼·/å¼±èˆ‡ç–«è‹—å·®è·ï¼‰
    const typeBias = ({virus:0, bacteria:-2, fungus:-3, protozoa:-1})[sel.type] || 0;
    const immuneScore = Math.max(0, immuneEnd + strongBias + vaccBias + typeBias);
    history.push({type:sel.type, state:sel.state, route:sel.route, vaccinated:sel.vaccinated, outcome, rounds, immuneEnd, immuneScore});
    refreshChartsAndTable();
  }
}

// ===== çµ±è¨ˆï¼šæ•´æ•¸åˆ»åº¦ Y è»¸ + è¦–åœ–åˆ‡æ›ï¼ˆå››å€‹æŒ‰éˆ•ï¼‰ =====
function aggAvgImmune(keys, keyName, vaccFilter=null){
  return keys.map(k=>{
    const items = history.filter(h=>h[keyName]===k && (vaccFilter===null || h.vaccinated===vaccFilter));
    const n=items.length;
    const wins = items.filter(h=>h.outcome==='immune_win'||h.outcome==='sneeze'||h.outcome==='gastric_acid').length;
    const avgImmune = n? (items.reduce((s,h)=>s+(h.immuneScore||h.immuneEnd||0),0)/n) : 0;
    return {key:k, n, avgImmune, rate: n? Math.round(wins/n*100): 0};
  });
}

function niceStepInt(maxVal){
  if(maxVal<=0) return 1;
  const exp = Math.floor(Math.log10(maxVal));
  const base = Math.pow(10, exp);
  const candidates = [1,2,5,10].map(m=>m*base);
  let step = candidates.find(s => maxVal / s <= 6) || candidates[candidates.length-1];
  step = Math.max(1, Math.round(step));
  return step;
}

function drawBars(canvasId, seriesA, seriesB, title, labels, colorA='#38bdf8', colorB='#f59e0b'){
  const c=document.getElementById(canvasId); const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const padL=56, padR=12, padT=18, padB=42; const W=c.width-padL-padR, H=c.height-padT-padB;

  const maxVal = Math.max(1, ...seriesA.map(d=>d.avgImmune||0), ...(seriesB?seriesB.map(d=>d.avgImmune||0):[0]));
  const upperRaw = maxVal*1.15;
  const step = niceStepInt(upperRaw/5);
  const yMax = Math.max(step, Math.ceil(upperRaw/step)*step);

  // åæ¨™èˆ‡æ•´æ•¸åˆ»åº¦
  ctx.strokeStyle='#334155'; ctx.strokeRect(padL,padT,W,H);
  ctx.fillStyle='#94a3b8'; ctx.font='12px system-ui'; ctx.textAlign='left';
  for(let v=0; v<=yMax+1e-6; v+=step){
    const y = padT + H * (1 - v / yMax);
    ctx.fillText((v).toFixed(0), 8, y+4);
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(padL+W,y); ctx.strokeStyle='rgba(148,163,184,.15)'; ctx.stroke();
  }

  const n=seriesA.length; const groupW=W/(n*1.3), gap=groupW*0.3;
  const isCompare = !!seriesB;

  seriesA.forEach((d,i)=>{
    const x0 = padL + i*(groupW+gap) + gap;
    if(isCompare){
      const bw = (groupW - 6)/2;
      const hA = H*((d.avgImmune||0) / yMax);
      const hB = H*(((seriesB[i]?.avgImmune)||0) / yMax);
      ctx.fillStyle=colorA; ctx.fillRect(x0, padT+H-hA, bw, hA);
      ctx.fillStyle=colorB; ctx.fillRect(x0+bw+6, padT+H-hB, bw, hB);
      ctx.fillStyle='#93c5fd'; ctx.textAlign='center';
      ctx.fillText((d.avgImmune||0).toFixed(1), x0+bw/2, Math.max(padT+12, padT+H-hA-6));
      ctx.fillStyle='#fde68a';
      ctx.fillText(((seriesB[i]?.avgImmune)||0).toFixed(1), x0+bw+6+bw/2, Math.max(padT+12, padT+H-hB-6));
      ctx.fillStyle='#cbd5e1'; ctx.fillText(labels[d.key], x0+groupW/2, padT+H+18);
    }else{
      const bw = groupW;
      const h = H*((d.avgImmune||0) / yMax);
      ctx.fillStyle=colorA; ctx.fillRect(x0, padT+H-h, bw, h);
      ctx.fillStyle='#93c5fd'; ctx.textAlign='center';
      ctx.fillText((d.avgImmune||0).toFixed(1), x0+bw/2, Math.max(padT+12, padT+H-h-6));
      ctx.fillStyle='#cbd5e1'; ctx.fillText(labels[d.key], x0+bw/2, padT+H+18);
    }
  });

  ctx.fillStyle='#cbd5e1'; ctx.textAlign='left'; ctx.fillText(title, padL, 14);
}

function refreshChartsAndTable(){
  const mode = document.querySelector('input[name="vaccView"]:checked').value; // ALL / VACC / UNVACC / COMPARE
  const legend = $('#legend'); legend.style.display = (mode==='COMPARE') ? 'flex' : 'none';

  const tALL = aggAvgImmune(keysPT,'type', null);
  const sALL = aggAvgImmune(keysST,'state', null);
  const rALL = aggAvgImmune(keysRT,'route', null);
  const tV = aggAvgImmune(keysPT,'type', true);
  const sV = aggAvgImmune(keysST,'state', true);
  const rV = aggAvgImmune(keysRT,'route', true);
  const tU = aggAvgImmune(keysPT,'type', false);
  const sU = aggAvgImmune(keysST,'state', false);
  const rU = aggAvgImmune(keysRT,'route', false);

  if(mode==='COMPARE'){
    drawBars('chartByType', tV, tU, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾ç—…åŸé«”ç¨®é¡ï½œæ¯”è¼ƒï¼‰', labelPT);
    drawBars('chartByState', sV, sU, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾äººé«”ç‹€æ³ï½œæ¯”è¼ƒï¼‰', labelST);
    drawBars('chartByRoute', rV, rU, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾é€²æ”»å…¥å£ï½œæ¯”è¼ƒï¼‰', labelRT);
  }else if(mode==='VACC'){
    drawBars('chartByType', tV, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾ç—…åŸé«”ç¨®é¡ï½œå·²æ–½æ‰“ç–«è‹—ï¼‰', labelPT);
    drawBars('chartByState', sV, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾äººé«”ç‹€æ³ï½œå·²æ–½æ‰“ç–«è‹—ï¼‰', labelST);
    drawBars('chartByRoute', rV, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾é€²æ”»å…¥å£ï½œå·²æ–½æ‰“ç–«è‹—ï¼‰', labelRT);
  }else if(mode==='UNVACC'){
    drawBars('chartByType', tU, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾ç—…åŸé«”ç¨®é¡ï½œæœªæ¥ç¨®ï¼‰', labelPT);
    drawBars('chartByState', sU, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾äººé«”ç‹€æ³ï½œæœªæ¥ç¨®ï¼‰', labelST);
    drawBars('chartByRoute', rU, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾é€²æ”»å…¥å£ï½œæœªæ¥ç¨®ï¼‰', labelRT);
  }else{
    drawBars('chartByType', tALL, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾ç—…åŸé«”ç¨®é¡ï½œå…¨éƒ¨ï¼‰', labelPT);
    drawBars('chartByState', sALL, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾äººé«”ç‹€æ³ï½œå…¨éƒ¨ï¼‰', labelST);
    drawBars('chartByRoute', rALL, null, 'å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆä¾é€²æ”»å…¥å£ï½œå…¨éƒ¨ï¼‰', labelRT);
  }

  // è¡¨æ ¼
  const tbody=$('#summaryRows'); const thead=$('#thead'); tbody.innerHTML='';
  if(mode==='COMPARE'){
    thead.innerHTML='<tr><th>ç¶­åº¦</th><th>åˆ†é¡</th><th>æ¨£æœ¬æ•¸ï¼ˆç–«è‹— / æœªæ¥ç¨®ï¼‰</th><th>å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼ï¼ˆç–«è‹— / æœªæ¥ç¨®ï¼‰</th><th>æˆåŠŸç‡ï¼ˆç–«è‹— / æœªæ¥ç¨®ï¼‰</th></tr>';
    const rows=[...keysPT.map(k=>({dim:'ç—…åŸé«”', name:labelPT[k],
                  nV:tV.find(x=>x.key===k).n, nU:tU.find(x=>x.key===k).n,
                  aV:tV.find(x=>x.key===k).avgImmune, aU:tU.find(x=>x.key===k).avgImmune,
                  rV:tV.find(x=>x.key===k).rate, rU:tU.find(x=>x.key===k).rate})),
                ...keysST.map(k=>({dim:'äººé«”ç‹€æ³', name:labelST[k],
                  nV:sV.find(x=>x.key===k).n, nU:sU.find(x=>x.key===k).n,
                  aV:sV.find(x=>x.key===k).avgImmune, aU:sU.find(x=>x.key===k).avgImmune,
                  rV:sV.find(x=>x.key===k).rate, rU:sU.find(x=>x.key===k).rate})),
                ...keysRT.map(k=>({dim:'é€²æ”»å…¥å£', name:labelRT[k],
                  nV:rV.find(x=>x.key===k).n, nU:rU.find(x=>x.key===k).n,
                  aV:rV.find(x=>x.key===k).avgImmune, aU:rU.find(x=>x.key===k).avgImmune,
                  rV:rV.find(x=>x.key===k).rate, rU:rU.find(x=>x.key===k).rate}))];
    if(!rows.some(r=>r.nV>0||r.nU>0)){ tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#94a3b8">å°šç„¡è³‡æ–™</td></tr>'; return; }
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.dim}</td><td>${r.name}</td>
        <td>${r.nV} / ${r.nU}</td>
        <td>${(r.aV||0).toFixed(1)} / ${(r.aU||0).toFixed(1)}</td>
        <td>${r.rV}% / ${r.rU}%</td>`;
      tbody.appendChild(tr);
    });
  }else{
    thead.innerHTML='<tr><th>ç¶­åº¦</th><th>åˆ†é¡</th><th>æ¨£æœ¬æ•¸</th><th>å¹³å‡å…ç–«é˜²ç¦¦åŠ›å€¼</th><th>å…ç–«æˆåŠŸç‡</th></tr>';
    const srcT = (mode==='VACC')? tV : (mode==='UNVACC')? tU : tALL;
    const srcS = (mode==='VACC')? sV : (mode==='UNVACC')? sU : sALL;
    const srcR = (mode==='VACC')? rV : (mode==='UNVACC')? rU : rALL;
    const rows=[...srcT.map(x=>({dim:'ç—…åŸé«”', name:labelPT[x.key], n:x.n, avg:x.avgImmune, rate:x.rate})),
                ...srcS.map(x=>({dim:'äººé«”ç‹€æ³', name:labelST[x.key], n:x.n, avg:x.avgImmune, rate:x.rate})),
                ...srcR.map(x=>({dim:'é€²æ”»å…¥å£', name:labelRT[x.key], n:x.n, avg:x.avgImmune, rate:x.rate}))];
    if(!rows.some(r=>r.n>0)){ tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#94a3b8">å°šç„¡è³‡æ–™</td></tr>'; return; }
    rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.dim}</td><td>${r.name}</td><td>${r.n}</td><td>${r.avg.toFixed(1)}</td><td>${r.rate}%</td>`; tbody.appendChild(tr); });
  }
}

// ç¶å®šæŒ‰éˆ•
$('#btnStart').onclick=()=>{
  const sel={
    type:document.querySelector('input[name="pathType"]:checked').value,
    state:document.querySelector('input[name="bodyState"]:checked').value,
    vaccinated:document.querySelector('input[name="vaccStatus"]:checked').value==='VACC',
    route:document.querySelector('input[name="route"]:checked').value
  };
  simulateBattle(sel);
};
$('#btnReset').onclick=()=>{resetLog();prog.pLv=prog.iLv=1;prog.pXP=prog.iXP=0;prog.pNext=prog.iNext=100;prog.memoryLevel=0;memoBadge.textContent='ç„¡';updateBars();log('å·²é‡è¨­');};
$('#btnClearStats').onclick=()=>{history.length=0; refreshChartsAndTable();};

// è¦–åœ– chips è®Šæ›´å³åˆ·æ–°
document.querySelectorAll('input[name="vaccView"]').forEach(el=>{
  el.addEventListener('change', refreshChartsAndTable);
});

// åˆå§‹
updateBars(); refreshChartsAndTable();
</script>
</body>
</html>