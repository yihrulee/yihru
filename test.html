<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>酵素活性學習單（A4可列印 + 互動）</title>
<style>
  :root{--gap:12px;}
  *{box-sizing:border-box;}
  body{font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif; margin:0; padding:16px; line-height:1.3;}
  h1{font-size:20px; margin:0 0 8px 0;}
  h2{font-size:16px; margin:18px 0 8px;}
  .row{display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap);}
  .card{border:1px solid #ccc; border-radius:8px; padding:12px;}
  label{font-size:13px;}
  table{width:100%; border-collapse:collapse; margin-top:6px; font-size:13px;}
  th, td{border:1px solid #999; padding:4px 6px; text-align:center;}
  th{background:#f3f3f3;}
  input[type="number"]{width:100%; padding:4px; text-align:center;}
  .meta{display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin-bottom:8px;}
  .meta label{display:flex; align-items:center; gap:6px;}
  .meta input{width:100%; padding:4px;}
  .controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px;}
  canvas{width:100%; height:320px; border:1px solid #999; border-radius:6px; background:#fff;}
  .cer{display:grid; grid-template-columns: 1fr; gap:var(--gap);}
  .cer textarea{width:100%; height:120px; border:1px dashed #777; padding:8px; font-size:14px; resize:vertical;}
  .footer{margin-top:10px; font-size:12px; color:#333;}
  .no-print{}
  @media print {
    @page{size:A4; margin:12mm;}
    body{padding:0;}
    .no-print{display:none !important;}
    button, input[type="radio"]{display:none;}
    a[href]:after{content:"";}
    canvas{height:260px;}
  }
  .hint{font-size:12px; color:#555;}
</style>
</head>
<body>
  <h1>酵素活性學習單：溫度與酸鹼度對速率的影響</h1>
  <div class="meta">
    <label>班級：<input id="cls" placeholder=""></label>
    <label>座號：<input id="no" placeholder=""></label>
    <label>姓名：<input id="name" placeholder=""></label>
    <label>日期：<input id="date" placeholder=""></label>
  </div>
  <div class="hint">速率指標可二選一：① 30 秒泡沫高度（cm）→ 速率 = 高度/30；② 達 5 cm 所需時間（s）→ 速率 = 1/時間。</div>

  <div class="row">
    <section class="card">
      <h2>實驗 A：溫度系列（固定 pH）</h2>
      <div>
        <label><input type="radio" name="metricA" value="height" checked> 30 秒泡沫高度（cm）</label>
        <label style="margin-left:12px;"><input type="radio" name="metricA" value="time"> 達 5 cm 所需時間（s）</label>
      </div>
      <table id="tableA">
        <thead>
          <tr><th>溫度（°C）</th><th>試次 1</th><th>試次 2</th><th>平均</th><th>速率</th></tr>
        </thead>
        <tbody>
          <tr><td contenteditable>10</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td class="avg"></td><td class="rate"></td></tr>
          <tr><td contenteditable>25</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td class="avg"></td><td class="rate"></td></tr>
          <tr><td contenteditable>37</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td class="avg"></td><td class="rate"></td></tr>
          <tr><td contenteditable>50</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td class="avg"></td><td class="rate"></td></tr>
        </tbody>
      </table>
      <div class="controls">
        <button class="no-print" onclick="addRow('tableA')">＋ 增加一列</button>
        <button class="no-print" onclick="calcTable('tableA','metricA')">計算平均與速率</button>
        <button class="no-print" onclick="plotGraph('A')">繪圖</button>
        <button class="no-print" onclick="clearCanvas('canvasA')">清除圖</button>
      </div>
      <canvas id="canvasA" width="800" height="420"></canvas>
    </section>

    <section class="card">
      <h2>實驗 B：pH 系列（固定溫度）</h2>
      <div>
        <label><input type="radio" name="metricB" value="height" checked> 30 秒泡沫高度（cm）</label>
        <label style="margin-left:12px;"><input type="radio" name="metricB" value="time"> 達 5 cm 所需時間（s）</label>
      </div>
      <table id="tableB">
        <thead>
          <tr><th>pH 值</th><th>試次 1</th><th>試次 2</th><th>平均</th><th>速率</th></tr>
        </thead>
        <tbody>
          <tr><td contenteditable>3</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td class="avg"></td><td class="rate"></td></tr>
          <tr><td contenteditable>7</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td class="avg"></td><td class="rate"></td></tr>
          <tr><td contenteditable>9</td><td><input type="number" step="0.1"></td><td><input type="number" step="0.1"></td><td class="avg"></td><td class="rate"></td></tr>
        </tbody>
      </table>
      <div class="controls">
        <button class="no-print" onclick="addRow('tableB')">＋ 增加一列</button>
        <button class="no-print" onclick="calcTable('tableB','metricB')">計算平均與速率</button>
        <button class="no-print" onclick="plotGraph('B')">繪圖</button>
        <button class="no-print" onclick="clearCanvas('canvasB')">清除圖</button>
      </div>
      <canvas id="canvasB" width="800" height="420"></canvas>
    </section>
  </div>

  <section class="card cer">
    <h2>CER 總結</h2>
    <label>主張（Claim）<textarea id="claim" placeholder="寫下你對『酵素具有最適溫度與最適 pH』的主張。"></textarea></label>
    <label>證據（Evidence）<textarea id="evidence" placeholder="引用本組圖表中的數據（峰值、對照組），寫出 2–3 句量化證據。"></textarea></label>
    <label>推論（Reasoning）<textarea id="reasoning" placeholder="用『酵素構形／變性』解釋為何遠離最適條件速率下降。"></textarea></label>
    <div class="footer">
      Exit Ticket：最適溫度 ____ °C；最適 pH ____；下一步改進 ________。
    </div>
    <div class="controls no-print">
      <button onclick="saveLocal()">儲存到本機</button>
      <button onclick="loadLocal()">載入最近一次</button>
      <button onclick="exportCSV()">匯出 CSV</button>
      <button onclick="window.print()">列印（A4）</button>
    </div>
  </section>

<script>
function addRow(tableId){
  const tbody = document.querySelector("#"+tableId+" tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `<td contenteditable></td>
    <td><input type="number" step="0.1"></td>
    <td><input type="number" step="0.1"></td>
    <td class="avg"></td><td class="rate"></td>`;
  tbody.appendChild(tr);
}

function toNumber(v){const n = parseFloat(v); return isNaN(n)? null : n;}

function calcTable(tableId, metricName){
  const rows = document.querySelectorAll("#"+tableId+" tbody tr");
  const metric = document.querySelector("input[name='"+metricName+"']:checked").value;
  rows.forEach(r=>{
    const t1 = toNumber(r.cells[1].querySelector("input").value);
    const t2 = toNumber(r.cells[2].querySelector("input").value);
    if(t1!=null || t2!=null){
      const arr = [t1,t2].filter(x=>x!=null);
      const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
      r.querySelector(".avg").textContent = avg? avg.toFixed(2): "";
      let rate = "";
      if(metric==="height" && avg!=null){
        rate = (avg/30).toFixed(3);
      }else if(metric==="time" && avg && avg>0){
        rate = (1/avg).toFixed(3);
      }
      r.querySelector(".rate").textContent = rate;
    }
  });
}

function getTableData(tableId){
  const rows = Array.from(document.querySelectorAll("#"+tableId+" tbody tr"));
  return rows.map(r=>{
    const x = toNumber(r.cells[0].textContent);
    const t1 = toNumber(r.cells[1].querySelector("input").value);
    const t2 = toNumber(r.cells[2].querySelector("input").value);
    const avg = toNumber(r.querySelector(".avg").textContent);
    const rate = toNumber(r.querySelector(".rate").textContent);
    return {x, t1, t2, avg, rate};
  }).filter(o=>o.x!=null);
}

function drawAxes(canvasId, xLabel, yLabel, xMin, xMax, xTicks, yMin, yMax, yTicks){
  const c = document.getElementById(canvasId);
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const m = {l:60, r:20, t:20, b:50};
  const W = c.width - m.l - m.r;
  const H = c.height - m.t - m.b;
  ctx.strokeStyle = "#000"; ctx.lineWidth = 1;
  ctx.strokeRect(m.l, m.t, W, H);
  ctx.font = "12px sans-serif";
  ctx.textAlign="center"; ctx.textBaseline="top";
  xTicks.forEach(t=>{
    const x = m.l + (t - xMin)/(xMax-xMin) * W;
    ctx.beginPath(); ctx.moveTo(x, m.t+H); ctx.lineTo(x, m.t+H+5); ctx.stroke();
    ctx.fillText(t, x, m.t+H+8);
    ctx.strokeStyle="#ddd"; ctx.beginPath(); ctx.moveTo(x, m.t); ctx.lineTo(x, m.t+H); ctx.stroke(); ctx.strokeStyle="#000";
  });
  ctx.textAlign="right"; ctx.textBaseline="middle";
  yTicks.forEach(t=>{
    const y = m.t + (1- (t - yMin)/(yMax-yMin)) * H;
    ctx.beginPath(); ctx.moveTo(m.l-5, y); ctx.lineTo(m.l, y); ctx.stroke();
    ctx.fillText(t, m.l-8, y);
    ctx.strokeStyle="#ddd"; ctx.beginPath(); ctx.moveTo(m.l, y); ctx.lineTo(m.l+W, y); ctx.stroke(); ctx.strokeStyle="#000";
  });
  ctx.textAlign="center"; ctx.textBaseline="top";
  ctx.fillText(xLabel, m.l + W/2, c.height - 20);
  ctx.save();
  ctx.translate(15, m.t + H/2); ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, 0, 0);
  ctx.restore();
  return {ctx, m, W, H};
}

function plotGraph(which){
  const isA = which==="A";
  const tableId = isA? "tableA" : "tableB";
  const canvasId = isA? "canvasA" : "canvasB";
  const xLabel = isA? "溫度（°C）" : "pH 值";
  const yLabel = "速率（任意單位）";

  const data = getTableData(tableId).filter(d=>d.rate!=null);
  if(data.length===0){ alert("請先輸入數據並點『計算平均與速率』"); return; }
  data.sort((a,b)=>a.x-b.x);

  let xMin = isA? 0 : 2, xMax = isA? 60 : 10;
  const xTicks = isA? [0,10,20,30,40,50,60] : [2,4,6,8,10];
  const rates = data.map(d=>d.rate);
  let yMax = Math.max(...rates)*1.2;
  if(yMax<=0) yMax = 1;
  const step = yMax/5;
  const yTicks = Array.from({length:6}, (_,i)=>(i*step).toFixed(2));

  const {ctx,m,W,H} = drawAxes(canvasId, xLabel, yLabel, xMin, xMax, xTicks, 0, yMax, yTicks);

  ctx.lineWidth = 2;
  ctx.strokeStyle = "#000";
  ctx.fillStyle = "#000";
  ctx.beginPath();
  data.forEach((d,i)=>{
    const x = m.l + (d.x - xMin)/(xMax-xMin) * W;
    const y = m.t + (1- d.rate/yMax) * H;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  data.forEach(d=>{
    const x = m.l + (d.x - xMin)/(xMax-xMin) * W;
    const y = m.t + (1- d.rate/yMax) * H;
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });
}

function clearCanvas(id){
  const c = document.getElementById(id);
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  if(id==="canvasA"){
    drawAxes("canvasA","溫度（°C）","速率（任意單位）",0,60,[0,10,20,30,40,50,60],0,1,[0,0.2,0.4,0.6,0.8,1.0]);
  }else{
    drawAxes("canvasB","pH 值","速率（任意單位）",2,10,[2,4,6,8,10],0,1,[0,0.2,0.4,0.6,0.8,1.0]);
  }
}

function saveLocal(){
  const payload = {
    meta: {
      cls: document.getElementById('cls').value,
      no: document.getElementById('no').value,
      name: document.getElementById('name').value,
      date: document.getElementById('date').value
    },
    A: {metric: document.querySelector('input[name="metricA"]:checked').value, rows: getTableData('tableA')},
    B: {metric: document.querySelector('input[name="metricB"]:checked').value, rows: getTableData('tableB')},
    cer: {
      claim: document.getElementById('claim').value,
      evidence: document.getElementById('evidence').value,
      reasoning: document.getElementById('reasoning').value
    }
  };
  localStorage.setItem("enzyme_ws", JSON.stringify(payload));
  alert("已儲存到本機（localStorage）。");
}

function loadLocal(){
  const raw = localStorage.getItem("enzyme_ws");
  if(!raw){ alert("尚無儲存資料"); return; }
  const data = JSON.parse(raw);
  document.getElementById('cls').value = data.meta.cls||"";
  document.getElementById('no').value = data.meta.no||"";
  document.getElementById('name').value = data.meta.name||"";
  document.getElementById('date').value = data.meta.date||"";

  document.querySelector(`input[name="metricA"][value="${data.A.metric||'height'}"]`).checked = true;
  document.querySelector(`input[name="metricB"][value="${data.B.metric||'height'}"]`).checked = true;

  function setTable(tableId, rows){
    const tbody = document.querySelector("#"+tableId+" tbody");
    tbody.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td contenteditable>${r.x??""}</td>
        <td><input type="number" step="0.1" value="${r.t1??""}"></td>
        <td><input type="number" step="0.1" value="${r.t2??""}"></td>
        <td class="avg">${(r.avg??"")}</td><td class="rate">${(r.rate??"")}</td>`;
      tbody.appendChild(tr);
    });
  }
  setTable("tableA", data.A.rows||[]);
  setTable("tableB", data.B.rows||[]);
  document.getElementById('claim').value = data.cer.claim||"";
  document.getElementById('evidence').value = data.cer.evidence||"";
  document.getElementById('reasoning').value = data.cer.reasoning||"";
  alert("已載入最近一次資料。");
}

function exportCSV(){
  const rowsA = getTableData("tableA").map(r=>["A(溫度)", r.x, r.t1, r.t2, r.avg, r.rate]);
  const rowsB = getTableData("tableB").map(r=>["B(pH)", r.x, r.t1, r.t2, r.avg, r.rate]);
  const meta = [["班級", document.getElementById('cls').value],
                ["座號", document.getElementById('no').value],
                ["姓名", document.getElementById('name').value],
                ["日期", document.getElementById('date').value]];
  const cerRows = [["Claim", document.getElementById('claim').value.replace(/\n/g," ")],
                   ["Evidence", document.getElementById('evidence').value.replace(/\n/g," ")],
                   ["Reasoning", document.getElementById('reasoning').value.replace(/\n/g," ")]];

  let csv = "種類,X,試次1,試次2,平均,速率\n";
  [...rowsA, ...rowsB].forEach(r=>{ csv += r.join(",") + "\n"; });
  csv += "\n" + meta.map(r=>r.join(",")).join("\n");
  csv += "\n" + cerRows.map(r=>r.join(",")).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "酵素活性學習單_資料.csv";
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
}

window.addEventListener("load", ()=>{
  clearCanvas('canvasA');
  clearCanvas('canvasB');
});
</script>
</body>
</html>
